---
title: 正向代理
cover: /cover/正向代理.png
date: 2023-11-25 19:13:30.102475
comments: True
abstracts: 以校园网访问谷歌为由，介绍如何配置正向代理服务器，涉及Clash、shadowsocks等多种代理方式，并补充无需代理的翻墙方式
mathjax: true
categories: 学术科研
tags:
- 代理服务器
-  流量转发
-  正向代理
---
# 正向代理

## 基本原理

## 流量转发

基于上面的原理，现使用 shadowsocks 工具实现代理服务器的流量转发

### 服务端

在 Ubuntu22.04 上安装 shadowsocks：

```bash
sudo apt-get install shadowsocks-libev
```

写一个配置脚本 shadowsock.json 配置代理的端口号和密码（主要是这两个）：

```json
{
    "server":["::0","0.0.0.0"],
    "server_port":1080,
    "local_port":1080,
    "password":"123456",
    "timeout":60,
    "method":"aes-256-gcm",
    "mode":"tcp_and_udp",
    "fast_open":false
}
```

在同级目录下写一个启动脚本：

```bash
ss-server -c ./shadowsocks.json -f start
```

- -c 的意思是指定配置文件（json）
- -f 的意思是以守护线程的方式运行，后面需要接参数 pid file，这里省略的话会默认在同级目录下新建一个 start 文件存放进程的 pid

同级目录下再写一个关闭脚本 shutdown.sh 如下：

```bash
#!/bin/bash

# 读取start文件中的PID
pid=$(cat start)

# 检查PID是否存在
if ps -p $pid > /dev/null; then
    # 进程存在，关闭它
    kill $pid
    echo "进程已关闭"
else
    # 进程不存在
    echo "进程不存在"
fi
```

或者用暴力办法，查进程强行 kill 即可：

```bash
# 查ss-server的进程，一般是两个，删掉自己运行的那个（注意看命令行信息）
ps -ef | grep [s]s-server
# 强制kill掉就行
kill -9
```

记得为两个脚本赋权：

```bash
sudo chmod +x start.sh
sudo chmod +x shutdown.sh
```

#### 开机自启

本人查过大量的网上资料，也动手实践过，目前并未找到非常好的方法实现开机自启，可能的原因包括但不限于：

1. 开机自启的方法问题（简单的脚本我开机自启成功过）
2. shadowsocks-libev 的版本问题（可以快速试一试，去 github 的 shadowsocks 官方）
3. shadowsocks 本身的问题（开源项目，背后可能没有公司维护）

因为服务器一般不关机，就让程序一直运行即可，必要的时候查进程号给 kill 掉就行：

同时注意要在防火墙放行端口，具体的方式可以在下面的**机场代理**小节查看

### 客户端

安装 shadowsocks GUI 客户端，windows 平台可以安装下面仓库的便携版：

> github 上找了大半天，基于命令行的挺多的，基于 GUI 的基本上都是上面的仓库，也有 Debian 上 GUI 的，但是 Debian 上为何不基于命令行？基于 GUI 的大多数是便携版，也能开机自启，够用了

右键点击图标，点击“服务器”，点击“编辑服务器”，填入代理地址信息：

<p align="center"><img src="/img/正向代理/UXRJbdsjyo7btdxYFTZcxmfKnKg.png" ></p>

<p align="center"><img src="/img/正向代理/GB6kb5SQko1RKCx88NKcxJStnJd.png" ></p>

```cpp
ipv6 address: 2401:ec00:15:1008:f2d4:e2ff:fee7:8004
prot: 1080
```

勾选“全局模式”，然后可以在“帮助”里选择“显示日志”查看流量转发情况。

### APP 代理

启用了上述代理后，一般浏览器都是可以正常代理的，一般软件都是不可以代理的。想要让软件的流量也被转发到代理服务器，一般通过软件自己的设置走代理，具体如下：

<p align="center"><img src="/img/正向代理/S4rRbLetGovvSFxa9gdc3K1tnJc.png" ></p>

这样的方式是比较简洁的方式，但是有的软件不提供代理，比如阿里云盘，这个时候就需要进行非常底层的全局代理软件来实现。

最绝对的方式是**透明代理**，也就是在路由器上设置代理，目前没有硬件条件无法实现。

最底层的代理软件似乎是 **SSTap**，它是通过建立虚拟网卡，将应用的流量走虚拟网卡，在虚拟网卡出对流量进行代理，但是好像对 Shadowsocks 的支持不是很好（对 ShadowSocksR 的支持较好？），我自己目前没成功，以后可以探究一下 ou_7f6ee51dd49317f10f80a0409adf4dc7

目前使用成功的代理软件是 **Proxifier**，可以代理许多常用的软件（有些软件还是无法代理，比如 ToDesk）

需要合理设置软件完成代理，在此之前，可以先不考虑连通性而关闭 ShadowSocks 的代理。下面将主要配置软件菜单栏的 Profile 部分：

<p align="center"><img src="/img/正向代理/VYqnbLXZxoqYoCxnlQCcXvjdnKb.png" ></p>

### IPV6 绕过校园网

一般来说，校园网通过学号和 IPV4 计费，但是一般使用 IPV6 发流量校园网将不计分；基本原理是找一台支持 IPV6 的代理服务器，客户端将 IPV6 流量发送到服务器上，服务器将 IPV6 流量转为 IPV4 发送给目标服务器，再取回。

值得一提的是，购买的机场服务器，是默认支持 IPV6 的，可以正常进行转发（个人购买的机场链接不支持 ShadowSocksR，进而使用 clash），配置如下：

<p align="center"><img src="/img/正向代理/L1k3bryaeoBCqVxJhkhc5v1Knmh.png" ></p>

更厉害的校园网白嫖方法见博客（涉及非常细节和底层的网络原理）：

## 曲线“翻墙”

正向代理的很大一个用处就是“翻墙”，“翻墙”主要是指访问 github 和 google，而此处的“曲线救国”是指在目标机器不配置代理的情况下，如何拿到上述两者的资源。但是如果需要访问墙外的资源，无论如何还是需要“翻墙”，只不过是直接和间接的区别。

### gitee 中转

对于 github 的仓库，其实很简单可以通过 gitee 进行转存，可以直接用 url 转存，也可以 gitee 绑定 github 账号，先用 github 账号 fork 之后再转存。这样做的好处就是目标机器会比较干净，且基于图像界面的操作虽然繁琐却比较简单。缺点就是在编译某些仓库时，会有许多依赖项需要去 github 上拉取，如果手动一个一个转存会非常花时间。

gitee 还可以看作一个中转站，不仅仅可以用于中转代码，还可以用于中转编译后的 obj，普通文件等等。但是其一次 push 的大小有限制，仓库的大小也有限制。

### 修改 hosts 访问 github

国内无法访问 github 的原因主要是 DNS 污染，可以通过使用工具查询 github 网站正确 IP，修改 hosts 文件实现访问 github。

首先使用 [IP 查询工具](https://tool.chinaz.com/dns)分别查询下面两个域名的 IP 地址：

```bash
# 适用于 https方式的克隆
github.com
github.global.ssl.fastly.net
```

查询得到地址后，修改 hosts 文件：

```bash
# Linux的 hosts文件目录
/etc/hosts
# Windows的 hosts文件目录
C:\Windows\System32\drivers\etc\hosts
```

在本机环回地址 localhost 后面添加上述的两个域名以及其 IP（需要管理员权限，linux 下使用 sudo vim 进行编辑）：

```
127.0.0.1       localhost
**20.205.243.166  github.com**
**199.96.58.15    github.global.ssl.fastly.net**
```

修改后刷新 DNS 缓存：

```bash
# Ubuntu下
sudo /etc/init.d/dns-clean start
# Windows Terminal下
ipconfig /flushdns
```

注意，上述手动方式修改 hosts 的方法虽然简单干净，但是由于 IP 地址时常发生变化，上述修改过一段时间后就容易失效，需要重新手动修改，会比较麻烦。网上会有一些[自动刷新的脚本](https://blog.csdn.net/e_00c/article/details/83618559?ydreferer=aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS8%3D)可以参考，但本人没有试过。

### 虚拟机流量转发

如果是使用的虚拟机，则可以让 [Host 机转发虚拟机的流量](http://lihuaxi.xjx100.cn/news/78969.html?action=onClick)，如果 Host 机可以访问外网，则虚拟机也可以访问外网。

本质上是使用 Clash For Windows 等代理软件的“Allow LAN”功能，因在 Windows 上配置代理相比 Linux 要简单得多：

<p align="center"><img src="/img/正向代理/WR4Bbd2N7oXnqBxa8iAck7bAnQc.png" ></p>

打开上述功能，同时可以看到代理端口是 7890，现找到虚拟机的 IP 地址，输入 win+r，打开 cmd，输入 ipconfig

找到 `VMware Network Adapter VMnet8`（默认使用 VMware 配置虚拟机，且网络方面是默认配置），其中 IPv4 的地址就是虚拟机的 IP 地址：

<p align="center"><img src="/img/正向代理/Lw9AbE6mYolsSIxTY5Bca37Qnld.png" ></p>

进入 Ubuntu（其他 Linux 发行版应该也是类似的流程），打开**设置-> 网络设置-> 网络代理**（不同系统名字会有些许差异，但大体意思都一样，就是代理的意思，**注意不是****VPN****，是代理！！！**），然后手动添加 HTTP 和 HTTPS 代理，IP 地址和端口如上所述：

<p align="center"><img src="/img/正向代理/GYOjbsZ6fodTGOxTzc8cFUCpnLf.png" ></p>

上述操作可以在 Chrome 等浏览器中可以访问外网，但有时需要终端走代理（如 pip、apt-get、yum 等），这时针对需要走代理的用户做如下设置：

```bash
export http_proxy='http://192.168.112.1:7890'
export https_proxy='http://192.168.112.1:7890'
export ALLOW_PROXY='http://192.168.112.1:7890'
```

如果只在 terminal 输入上述结果，只会当前 terminal 生效，需要永久生效则需要写入 `~/.bashrc` 文件中

```bash
vim ~/.bashrc
# 输入下面内容，使用wq保存退出
# export http_proxy='http://192.168.112.1:7890'
# export https_proxy='http://192.168.112.1:7890'
# 使立即生效
source ~/.bashrc
```

## 机场代理

真正要访问外网，还是需要外网服务器。可以自行去 [Vultr](https://my.vultr.com/) 购买，然后类似上面流量转发配置自己的服务器（注意防火墙放行端口）。还有一种是购买代理服务，也就是常说的“机场”，机场会为用户配置好代理服务器，用户只需用代理工具连接即可。

机场代理需要首先订阅机场链接；使用的代理软件是 [clash](https://github.com/Dreamacro/clash) 的 linux 版本，并且整合 clash 的 GUI 组件 [yacd](https://github.com/haishanh/yacd)（ClashDashboard），具体的信息可以自行查看 github 仓库 [clash-for-linux](https://github.com/wanhebin/clash-for-linux)。

这里以阿里云 ECS 服务器为例，介绍如何为远程服务器配置代理。

### 基本使用

克隆仓库：

```bash
# 可以访问github使用下面的链接
git clone https://github.com/wanhebin/clash-for-linux.git
# 无法访问github使用本人公开的仓库
git clone https://gitee.com/failurejack/clash-for-linux.git
```

设置订阅链接和密码：

```bash
cd clash-for-linux
vim .env
```

<p align="center"><img src="/img/正向代理/T458bUMKroVOd9xCJhdcA7RwnSf.png" ></p>

CLASH_URL 处粘贴为你个人的订阅地址，CLASH_SECRET 处写上 ClashDashboard 的登录密码，如何此处为空，将随机生成字符串，并在后面的启动中打印到控制台。

<p align="center"><img src="/img/正向代理/SRrMblWx5o1YmKxIDnZccgmfnRe.png" ></p>

启动 clash-for-linux

```bash
# 这里确保要使用 sudo 和 bash 执行
sudo bash start.sh
```

正常情况下终端打印如下：

<p align="center"><img src="/img/正向代理/UJ1Xb6t1coVkbHxKbzec09iwn1b.png" ></p>

可以看到 GUI 的密码和地址在控制台中被打印出来，有关 Dashboard 的问题，将在下一小节**“GUI 配置”**叙述。

先查看各种服务进程是否已经启动：

```bash
netstat -tln | grep -E '9090|789.'
```

正常情况结果如下：

<p align="center"><img src="/img/正向代理/TkJubjtDwoU8cjx0duzc0EisnVf.png" ></p>

上述四个端口号代表的进程都启动时，证明连接已经建立，此时只需要将流量代理到 `http://127.0.0.1:7890` 即可。由于在远程服务器上主要使用 terminal 工作，因此这里介绍如何在在 terminal 中开启代理。

与**“****虚拟机****流量转发”**章节中类似，在 terminal 代理流量分为暂时性代理和永久代理。暂时性代理只会在当前 terminal 生效，新建或切换为其他 terminal 都无效，具体方法就是输入如下代理命令：

```bash
export http_proxy='http://127.0.0.1:7890'
export https_proxy='http://127.0.0.1:7890'
```

永久生效就是将上述内容写入 `~/.bashrc` 文件末尾。

然而，有时候需要频繁开关代理，因此 clash-for-linux 采用了更为方便的方法（其实就是写了 shell 脚本）：

```bash
# 加载环境变量
source /etc/profile.d/clash.sh
# 开启代理
proxy_on
# 查看环境变量中的代理
env | grep -E 'http_proxy|https_proxy'
```

即加载 `/etc/profile.d/clash.sh` 脚本文件中所设置的环境变量，以便在当前 shell 会话中使用。这个文件定义了 proxy_on 和 proxy_off 两个函数供调用，可以方便地开关代理（注意是当前 terminal 生效）。正常情况输出如下：

<p align="center"><img src="/img/正向代理/X9WYbdbC7oujfCxW7wccxjJ0nnb.png" ></p>

如果换了 terminal，只需要输入命令 `source /etc/profile.d/clash.sh` 即可正常使用。此时可以科学上网：

<p align="center"><img src="/img/正向代理/UNRZb7NMroF3SvxUkqrcFNn0nGf.png" ></p>

由于服务器重启次数较少，因此 clash 的四个进程可以保持开启，若是重启了服务器，重启该进程即可（代理进程一般也没多重要），没必要配置开机启动、守护进程等。这简单介绍一下服务的关闭：

```bash
# 这里确保要使用 sudo 和 bash 执行，**注意一定是shutdown.sh而不是shutdown，shutdown是关机**
sudo bash shutdown.sh
```

### GUI 配置

上述命令行的配置是通用的，一般而言配置成功后机场会自动选择节点，可以正常科学上网。但是想要切换节点或者其他方面的应用则需要配置 GUI。

#### Clash Dashboard

上述启动的四个 clash 的进程中，端口号为 9090 的是 Dashboard 的进程：

<p align="center"><img src="/img/正向代理/KLQnbNYozour91x19Gtc6S88nLf.png" ></p>

如果本机有 GUI 界面，则直接打开浏览器，输入地址 `http://127.0.0.1:9090/ui` 访问 Dashboard：

<p align="center"><img src="/img/正向代理/JfwXbQfOioC5tuxOwYZcVgVVnU5.png" ></p>

这里的 `API Base URL` 输入：`http://127.0.0.1:9090`，`Secret` 输入之前打印在 terminal 中的内容，我这里是 `123456`，点击 Add，会在下方新增一个带有*的区块，点击该区块进入控制界面：

<p align="center"><img src="/img/正向代理/XTBdbC7aMoT43WxPjuPcuyaxnub.png" ></p>

点击 Proxies 即可切换节点，点击菜单栏的其他选项可以进行更高级的配置。如果是没有图形化界面的服务器，则需要远程访问部署在服务器上的网站（需要公网 IP）。

首先启动了 9090 端口的进程后，需要服务器的防火墙放行。一般云服务器厂商不会配置放行 9090 端口，需要自行设置，或者直接关闭防火墙：

```bash
sudo ufw disable
```

此时可以仅靠阿里云 ECS 的安全组实现流量控制，但是终归安全性不是那么高，因此下面介绍如何配置防火墙：

```bash
# 先开启防火墙
sudo ufw enable
# 可以先看一下防火墙通过列表，查看是否允许9090端口通过
sudo ufw status
# 没有则允许9090端口建立tcp连接
sudo ufw allow 9090/tcp

# 可以删除已经配置的通过
# sudo ufw delete allow 9090/tcp
```

此时完成服务器防火墙的配置，还需配置 ECS 安全组。

阿里云 ECS 在防火墙的基础上设置了一层虚拟防火墙，即 ECS 的安全组，需要配置放行 9090 端口。

进入 ECS 控制台：[https://www.aliyun.com/product/ecs](https://www.aliyun.com/product/ecs)

点击进入目标服务器的管理界面：

<p align="center"><img src="/img/正向代理/XrjPbPWlLoufeHxH3MHctW3Pnff.png" ></p>

切换到安全组选项卡，点击配置规则：

<p align="center"><img src="/img/正向代理/BiftbG5yko7OHCxVOd3cIuT0naf.png" ></p>

ECS 默认出方向无需配置，能够从 ECS 服务器转发所有流量包，需要配置进入服务器的流量，即入方向：

<p align="center"><img src="/img/正向代理/SCkxbCGSnofThdxcAsucX3dHnmg.png" ></p>

添加规则如下，注意端口范围手动输入 9090，授权对象为 0.0.0.0/0 允许任何 IP 访问，其他默认即可，点击保存。

<p align="center"><img src="/img/正向代理/PkWSb9nBuoMBLix36pWcNYnvncd.png" ></p>

至此可以顺利访问 Dashboard。此时 IP 换成服务器公网 IP，使用浏览器访问 `http://47.120.34.224:9090/ui`，注意 IP 的不同，其他的操作跟本机上的操作一样。

#### 浏览器

配置浏览器的代理（也许可以在.bashrc 配置全局代理），这里以 Ubuntu 桌面版预装的火狐浏览器为例，打开火狐浏览器的设置，搜索 proxy，点击 Network Settings 中的 Settings 按钮：

<p align="center"><img src="/img/正向代理/I8O8bGe0oocSzuxn3r0cF9mnnHb.png" ></p>

进入之后，勾选 Manual proxy configuration，HTTP Proxy 输入本机回环地址 127.0.0.1，端口为 7890，勾选 Also use this proxy for HTTPS，点击 OK 即可：

<p align="center"><img src="/img/正向代理/ILVabaHn1o0Gh2xbH14cuYsPnJd.png" ></p>

至此可以通过浏览器科学上网。
